<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercado da Raposa</title>
    <style>
        /* Estilos CSS completos do seu jogo */
        body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #222; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        .hidden { display: none !important; }
        #main-container { display: flex; gap: 20px; align-items: flex-start; }
        #game-container { position: relative; }
        #game-area { width: 800px; height: 600px; border: 2px solid #fff; background: url('imagens/florestamercador.png') center/cover no-repeat; position: relative; }
        .entity { position: absolute; background-size: contain; background-repeat: no-repeat; }
        #player { width: 64px; height: 64px; background-image: url('imagens/gatinho_pixel_32x32.png'); z-index: 10; }
        #npc-raposa { width: 128px; height: 128px; background-image: url('imagens/raposamercador.png'); top: 250px; left: 300px; cursor: pointer; }
        #mercado-stall { width: 230px; height: 230px; background-image: url('imagens/mercadoesquerdo.png'); top: 100px; left: 140px; cursor: pointer; }
        #ui-column { display: flex; flex-direction: column; align-items: center; }
        #status-board { font-size: 18px; margin-bottom: 10px; text-align: left; width: 250px; }
        #inventory-display { width: 250px; height: 550px; background-color: #1c2833; border: 2px solid #fff; padding: 10px; box-sizing: border-box; overflow-y: auto; }
        #inventory-title { margin: 0 0 10px 0; text-align: center; font-size: 20px; }
        .inventory-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        #shop-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(0, 0, 0, 0.85); }
        #shop-box { position: relative; padding: 20px; background-color: #1c2833; border: 2px solid #fff; border-radius: 10px; text-align: center; }
        #shop-close-button { position: absolute; top: 10px; right: 15px; font-size: 24px; color: white; background: none; border: none; cursor: pointer; }
        #shop-controls { display: flex; gap: 15px; margin-top: 20px;}
        #shop-title { font-size: 36px; margin-bottom: 20px; }
        #shop-items { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 750px; }
        .shop-item { width: 140px; height: 140px; padding: 5px; box-sizing: border-box; border: 2px solid #ddd; background-color: #444; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; cursor: pointer; transition: all 0.2s; border-radius: 8px; }
        .shop-item.rare { border-color: #8e44ad; } .shop-item.legendary { border-color: #e74c3c; box-shadow: 0 0 15px #e74c3c; }
        .shop-item:hover { background-color: #555; transform: scale(1.05); }
        .shop-item.disabled { background-color: #222; color: #555; cursor: not-allowed; opacity: 0.6; }
        .shop-item-symbol { font-size: 40px; } .shop-item-name { font-size: 16px; font-weight: bold; margin-top: 5px;}
        #item-description { margin-top: 20px; height: 50px; font-size: 18px; text-align: center; width: 600px;}
        #proceed-button, #reroll-button { padding: 10px 20px; font-size: 20px; cursor: pointer; }
        #reroll-button:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #dialogue-box { display: flex; flex-direction: column; justify-content: center; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 750px; padding: 20px; background-color: rgba(10, 20, 40, 0.9); border: 3px solid #bda25a; border-radius: 10px; text-align: center; z-index: 300; }
        #dialogue-text { font-size: 22px; margin: 0 0 20px 0; min-height: 50px; }
        #dialogue-next-button { font-size: 18px; padding: 10px 20px; border: 2px solid #bda25a; background-color: #2c3e50; color: white; cursor: pointer; align-self: flex-end; }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="game-container">
            <div id="game-area">
                <div id="player" class="entity"></div>
                <div id="npc-raposa" class="entity"></div>
                <div id="mercado-stall" class="entity"></div>
                <div id="dialogue-box" class="hidden">
                    <p id="dialogue-text"></p>
                    <button id="dialogue-next-button">Pr√≥ximo ></button>
                </div>
            </div>
        </div>
        <div id="ui-column">
            <div id="status-board">
                 <div>Sala: <span id="current-room">?</span></div>
                 <div>Vida: <span id="player-health">?</span></div>
                 <div>Escudo: <span id="player-shield">?</span></div>
                 <div>Ataque: <span id="player-attack">?</span></div>
                 <div>Moedas: <span id="player-coins">?</span></div>
            </div>
            <div id="inventory-display"><h3 id="inventory-title">Itens Comprados</h3><div id="inventory-list"></div></div>
        </div>
    </div>
    
    <div id="shop-overlay" class="screen hidden">
        <div id="shop-box">
            <button id="shop-close-button">X</button>
            <h2 id="shop-title">Mercado da Raposa</h2>
            <div id="shop-items"></div>
            <p id="item-description">Passe o mouse sobre um item para ver a descri√ß√£o.</p>
            <div id="shop-controls">
                <button id="reroll-button">Rerolar (0)</button>
                <button id="proceed-button">Ir para a pr√≥xima sala</button>
            </div>
        </div>
    </div>

    <script>
    // --- L√ìGICA DE DADOS ---
    function getNewPlayerState() { const state = { x: 385, y: 520, speed: 4, baseHealth: 10, bonusHealth: 0, baseAttack: 1, bonusAttack: 0, shield: 0, coins: 30, inventory: new Map(), currentRoom: 0, shopRerolls: 0, hasGrapesUpgrade: false, rareFindChance: 0.4, legendaryFindChance: 0.15, extraShopSlots:0, raposaDialogueDone: false, companionsToSummon: [] }; Object.defineProperty(state, 'health', { get() { return this.baseHealth + this.bonusHealth; }, configurable: true }); Object.defineProperty(state, 'attack', { get() { return this.baseAttack + this.bonusAttack; }, configurable: true }); return state; }
    function savePlayerState(state) { const savableState = { ...state, inventory: Array.from(state.inventory.entries()) }; localStorage.setItem('meuJoguinhoState_v27', JSON.stringify(savableState)); }
    function loadPlayerState() { const savedStateJSON = localStorage.getItem('meuJoguinhoState_v27'); if (!savedStateJSON) return null; const loadedObject = JSON.parse(savedStateJSON); const restoredState = { ...getNewPlayerState(), ...loadedObject, inventory: new Map(loadedObject.inventory) }; Object.defineProperty(restoredState, 'health', { get() { return this.baseHealth + this.bonusHealth; }, configurable: true }); Object.defineProperty(restoredState, 'attack', { get() { return this.baseAttack + this.bonusAttack; }, configurable: true }); return restoredState; }

    // --- SETUP DA P√ÅGINA ---
    const refs = { player: document.getElementById('player'), npc: document.getElementById('npc-raposa'), stall: document.getElementById('mercado-stall'), shop: { overlay: document.getElementById('shop-overlay'), closeButton: document.getElementById('shop-close-button'), itemsContainer: document.getElementById('shop-items'), description: document.getElementById('item-description'), proceedButton: document.getElementById('proceed-button'), rerollButton: document.getElementById('reroll-button') }, dialogue: { box: document.getElementById('dialogue-box'), text: document.getElementById('dialogue-text'), nextButton: document.getElementById('dialogue-next-button') }, ui: { room: document.getElementById('current-room'), health: document.getElementById('player-health'), shield: document.getElementById('player-shield'), attack: document.getElementById('player-attack'), coins: document.getElementById('player-coins'), inventory: document.getElementById('inventory-list') } };
    let playerState = loadPlayerState() || getNewPlayerState();
    let gameState = 'PLAYING';
    const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };

    // --- DI√ÅLOGO ORIGINAL DA RAPOSA ---
    let dialogueIndex = 0;
    const raposaInitialDialogues = [
        "Ol√°, jovem aventureiro! Que bom v√™-lo por aqui.", 
        "A floresta est√° perigosa com o ex√©rcito da Rainha Uva...", 
        "...mas n√£o se preocupe, eu tenho os melhores produtos para te fortalecer!", 
        "Fique √† vontade para olhar minha barraca. Se precisar de algo, √© s√≥ falar comigo!"
    ];
    const raposaRepeatDialogue = "De volta, aventureiro? Meus produtos continuam sendo os melhores da floresta!";

    function advanceRaposaDialogue() { if (dialogueIndex < raposaInitialDialogues.length) { refs.dialogue.text.textContent = raposaInitialDialogues[dialogueIndex]; dialogueIndex++; } else { refs.dialogue.box.classList.add('hidden'); gameState = 'PLAYING'; playerState.raposaDialogueDone = true; playerState.y += 20; } }
    function startRaposaDialogue() { gameState = 'PAUSED'; refs.dialogue.box.classList.remove('hidden'); if (!playerState.raposaDialogueDone) { dialogueIndex = 0; refs.dialogue.nextButton.textContent = 'Pr√≥ximo >'; refs.dialogue.nextButton.onclick = advanceRaposaDialogue; advanceRaposaDialogue(); } else { refs.dialogue.text.textContent = raposaRepeatDialogue; refs.dialogue.nextButton.textContent = 'Fechar'; refs.dialogue.nextButton.onclick = () => { refs.dialogue.box.classList.add('hidden'); gameState = 'PLAYING'; playerState.y += 20; }; } }

    // --- L√ìGICA COMPLETA DO MERCADO ---
    // Cole sua masterShopList COMPLETA aqui
    const masterShopList = [
        {id:'alface',name:'Alface',symbol:'ü•¨',desc:'Concede 30 de escudo.',cost:30,stackable:true, onPurchase: () => { playerState.shield += 30; }},
        {id:'laranja',name:'Laranja',symbol:'üçä',desc:'Dispara 5 proj√©teis a cada 5s (+2 de dano por compra).',cost:35,stackable:true,onPurchase:()=>{playerState.orangeUpgrade=(playerState.orangeUpgrade||0)+1}},
        {id:'macarrao',name:'Macarr√£o',symbol:'üçù',desc:'Ganha um tiro autom√°tico que causa lentid√£o (+10% por compra).',cost:35,stackable:true,onPurchase:()=>{playerState.hasPastaShot=true;playerState.pastaSlowFactor=(playerState.pastaSlowFactor||0)+0.1}},
        {id:'melancia',name:'Melancia',symbol:'üçâ',desc:'Cria uma orbe de dano ao seu redor (+10 de dano por compra).',cost:40,stackable:true,onPurchase:()=>{playerState.watermelonOrb.damage+=10;}},
        {id:'ovelha',name:'Ovelha',symbol:'üêë',desc:'Dobra o valor do seu escudo atual.',cost:25,stackable:true,onPurchase:()=>{if(playerState.shield>0)playerState.shield*=2}},
        {id:'brocolis',name:'Br√≥colis',symbol:'ü•¶',desc:'Ganha +1 chance de rerolar os itens da loja.',cost:15,stackable:true,onPurchase:()=>{playerState.shopRerolls++;}},
        {id:'manteiga',name:'Manteiga',symbol:'üßà',desc:'Cria uma aura que empurra inimigos pr√≥ximos (+alcance por compra).',cost:20,stackable:true,maxStacks:10,onPurchase:()=>{playerState.butterStacks+=1;}},
        {id:'pepino',name:'Pepino',symbol:'ü•í',desc:'Adiciona +1 op√ß√£o de item no pr√≥ximo mercado (m√°x. 12).',cost:20,stackable:true,maxStacks:9,onPurchase:()=>{if(playerState.extraShopSlots<9)playerState.extraShopSlots++;}},
        {id:'uvasVerdes',name:'Uvas Verdes',symbol:'üü¢',desc:'Coleta 10% das moedas n√£o pegas no fim da sala (acumul√°vel).',cost:20,stackable:true,onPurchase:()=>{if(playerState.greenGrapesStacks<20)playerState.greenGrapesStacks++;}},
        {id:'doceDeLeite',name:'Doce de Leite',symbol:'üçÆ',desc:'Seus companheiros ganham +20 Vida e +10 Dano.',cost:30,stackable:true,onPurchase:()=>{playerState.companionBuffs.bonusHealth+=20;playerState.companionBuffs.bonusDamage+=10;}},
        {id:'cremeDeLeite',name:'Creme de Leite',symbol:'ü•õ',desc:'+4 de cura por segundo para o Amigo Iogurte.',cost:25,stackable:true,onPurchase:()=>{}},
        {id:'pao',name:'P√£o',symbol:'üçû',desc:'Aumenta a chance de achar itens raros/lend√°rios em 50%.',cost:40,stackable:false,onPurchase:()=>{playerState.rareFindChance*=1.5;playerState.legendaryFindChance*=1.5;}},
        {id:'tomate',name:'Tomate',symbol:'üçÖ',desc:'Dobra seu ataque base permanentemente.',cost:30,stackable:false,onPurchase:()=>{playerState.baseAttack*=2;}},
        {id:'caixaDeLeite',name:'Caixa de Leite',symbol:'Lü•õ',desc:'Leite agora cura o dobro (passivo).',cost:30,stackable:false,onPurchase:()=>{playerState.milkUpgrade=true;}},
        {id:'maca',name:'Ma√ß√£',symbol:'üçé',desc:'Tiros t√™m 50% de chance de aplicar veneno.',cost:30,stackable:false,onPurchase:()=>{playerState.hasPoisonUpgrade=true;}},
        {id:'uvas',name:'Uvas',symbol:'üçá',desc:'Moedas coletadas valem o dobro.',cost:30,stackable:false,onPurchase:()=>{playerState.hasGrapesUpgrade=true;}},
        {id:'frango',name:'Frango',symbol:'üçó',desc:'Permite que Ovos apare√ßam nas fases (+1 Vida, +1 Dano).',cost:30,stackable:false,onPurchase:()=>{playerState.canSpawnEggs=true;}},
        {id:'bife',name:'Bife',symbol:'ü•©',desc:'Seus tiros agora v√£o na dire√ß√£o em que voc√™ se move.',cost:30,stackable:false,onPurchase:()=>{playerState.aimInMoveDirection=true;}},
        {id:'coelho',name:'Coelho',symbol:'üêá',desc:'Atira um proj√©til adicional (tiro duplo).',cost:40,stackable:false,onPurchase:()=>{playerState.hasDoubleShot=true;}},
        {id:'batidaDeBanana',name:'Batida de Banana',symbol:'üçå',desc:'Bananas agora curam 3 de vida.',cost:25,stackable:false,onPurchase:()=>{playerState.bananaUpgrade=true;}},
        {id:'bolo',name:'Bolo',symbol:'üéÇ',desc:'(RARO) Seu tiro principal se torna teleguiado.',cost:60,stackable:false,rarity:'rare',onPurchase:()=>{playerState.hasHomingShots=true;}},
        {id:'chocolate',name:'Chocolate',symbol:'üç´',desc:'(RARO) Conjura um amigo chocolate.',cost:70,stackable:false,rarity:'rare',onPurchase:()=>{if(!playerState.companionsToSummon.includes('chocolate')) playerState.companionsToSummon.push('chocolate')}},
        {id:'pytaya',name:'Pytaya',symbol:'üêâ',desc:'(RARO) Conjura um amigo drag√£o.',cost:80,stackable:false,rarity:'rare',onPurchase:()=>{if(!playerState.companionsToSummon.includes('dragon')) playerState.companionsToSummon.push('dragon')}},
        {id:'sorvete',name:'Sorvete',symbol:'üç¶',desc:'(RARO) Conjura um amigo sorvete.',cost:45,stackable:false,rarity:'rare',onPurchase:()=>{if(!playerState.companionsToSummon.includes('ice_cream')) playerState.companionsToSummon.push('ice_cream')}},
        {id:'iogurte',name:'Iogurte',symbol:'üç∂',desc:'(RARO) Conjura um amigo iogurte que cura.',cost:50,stackable:false,rarity:'rare',onPurchase:()=>{if(!playerState.companionsToSummon.includes('yogurt')) playerState.companionsToSummon.push('yogurt')}},
        {id:'queijo',name:'Queijo',symbol:'üßÄ',desc:'(RARO) Conjura um amigo queijo que coleta itens.',cost:40,stackable:false,rarity:'rare',onPurchase:()=>{if(!playerState.companionsToSummon.includes('cheese')) playerState.companionsToSummon.push('cheese')}},
        {id:'sucoDeLaranja',name:'Suco de Laranja',symbol:'üßÉüçä',desc:'(RARO) Dobra o dano dos proj√©teis da Laranja.',cost:50,stackable:false,rarity:'rare',onPurchase:()=>{playerState.orangeJuiceUpgrade=true;}},
        {id:'sucoDeMaca',name:'Suco de Ma√ß√£',symbol:'ü•§üçé',desc:'(RARO) Veneno da Ma√ß√£ causa +30 de dano por segundo.',cost:50,stackable:false,rarity:'rare',onPurchase:()=>{playerState.poisonDPS+=30;}},
        {id:'sucoDeUva',name:'Suco de Uva',symbol:'üßÉüçá',desc:'(RARO) Ganha +10 Vida/Ataque para cada 50 moedas.',cost:60,stackable:false,rarity:'rare',onPurchase:()=>{playerState.hasGrapeJuice=true;}},
        {id:'tortaDeUva',name:'Torta de Uva',symbol:'ü•ß',desc:'(RARO) Seu escudo se torna igual √† sua quantidade de moedas.',cost:40,stackable:false,rarity:'rare',onPurchase:()=>{playerState.hasGrapePie=true;}},
        {id:'cucaDeUva',name:'Cuca de Uva',symbol:'üç∞',desc:'(RARO) Ao tomar dano, perde moedas em vez de vida/escudo.',cost:50,stackable:false,rarity:'rare',onPurchase:()=>{playerState.hasGrapeCuca=true;}},
        {id:'uvaBranca',name:'Uva Branca',symbol:'‚ö™',desc:'(LEND√ÅRIO) Conjuras t√™m 200% de velocidade de ataque.',cost:100,stackable:false,rarity:'legendary',onPurchase:()=>{playerState.hasWhiteGrape=true;}}
    ];
    function updateStatusBoard() { refs.ui.room.textContent = playerState.currentRoom; refs.ui.health.textContent = playerState.health.toFixed(0); refs.ui.shield.textContent = playerState.shield.toFixed(0); refs.ui.attack.textContent = playerState.attack.toFixed(0); refs.ui.coins.textContent = playerState.coins; }
    function updateInventoryDisplay() { refs.ui.inventory.innerHTML = ''; playerState.inventory.forEach((count, name) => { const itemEl = document.createElement('div'); itemEl.className = 'inventory-item'; itemEl.textContent = `${name} ${count > 1 ? `x${count}` : ''}`; refs.ui.inventory.appendChild(itemEl); }); }
    function applyShopItemEffect(itemId) { const itemData = masterShopList.find(i => i.id === itemId); if (!itemData || playerState.coins < itemData.cost) return; const invCount = playerState.inventory.get(itemData.name) || 0; if (itemData.stackable === false && invCount > 0) return; if (itemData.maxStacks && invCount >= itemData.maxStacks) return; playerState.coins -= itemData.cost; if (itemData.onPurchase) itemData.onPurchase(); playerState.inventory.set(itemData.name, invCount + 1); updateStatusBoard(); updateInventoryDisplay(); openShop(); }
    function openShop() { refs.shop.overlay.classList.remove('hidden'); refs.shop.itemsContainer.innerHTML = ''; const pool = masterShopList.filter(i => { const invCount = playerState.inventory.get(i.name) || 0; if (i.stackable === false) return invCount === 0; const max = i.maxStacks || Infinity; return invCount < max; }); const common = pool.filter(i => !i.rarity), rare = pool.filter(i => i.rarity === 'rare'), legendary = pool.filter(i => i.rarity === 'legendary'); let itemsToShow = []; if (legendary.length > 0 && Math.random() < playerState.legendaryFindChance) itemsToShow.push(legendary.sort(() => 0.5 - Math.random())[0]); if (rare.length > 0 && Math.random() < playerState.rareFindChance) itemsToShow.push(rare.sort(() => 0.5 - Math.random())[0]); const commonSlots = (3 + playerState.extraShopSlots) - itemsToShow.length; if (common.length > 0 && commonSlots > 0) itemsToShow.push(...common.sort(() => 0.5 - Math.random()).slice(0, commonSlots)); itemsToShow.forEach(itemData => { const itemDiv = document.createElement('div'); itemDiv.className = `shop-item ${itemData.rarity || ''}`; itemDiv.innerHTML = `<div class="shop-item-symbol">${itemData.symbol}</div><div class="shop-item-name">${itemData.name}</div>`; if (playerState.coins < itemData.cost) itemDiv.classList.add('disabled'); itemDiv.addEventListener('mouseover', () => { refs.shop.description.textContent = `${itemData.desc} (Custo: ${itemData.cost} moedas)`; }); itemDiv.addEventListener('click', () => applyShopItemEffect(itemData.id)); refs.shop.itemsContainer.appendChild(itemDiv); }); refs.shop.description.textContent = 'Passe o mouse sobre um item para ver a descri√ß√£o.'; refs.shop.rerollButton.textContent = `Rerolar (${playerState.shopRerolls})`; refs.shop.rerollButton.disabled = playerState.shopRerolls <= 0; }
    function checkCollision(div1, div2, inset = 0) { const r1 = div1.getBoundingClientRect(), r2 = div2.getBoundingClientRect(); const sr2 = { left: r2.left + inset, right: r2.right - inset, top: r2.top + inset, bottom: r2.bottom - inset }; return !(r1.right < sr2.left || r1.left > sr2.right || r1.bottom < sr2.top || r1.top > sr2.bottom); }

    // --- LOOP DA CENA ---
    function sceneLoop() {
        if (gameState === 'PLAYING') {
            if (keys.ArrowUp) playerState.y -= playerState.speed; if (keys.ArrowDown) playerState.y += playerState.speed; if (keys.ArrowLeft) playerState.x -= playerState.speed; if (keys.ArrowRight) playerState.x += playerState.speed;
            const playerSize = 64;
            playerState.x = Math.max(0, Math.min(playerState.x, 800 - playerSize));
            playerState.y = Math.max(0, Math.min(playerState.y, 600 - playerSize));
            refs.player.style.left = playerState.x + 'px'; refs.player.style.top = playerState.y + 'px';
            if (checkCollision(refs.player, refs.npc, 40)) { startRaposaDialogue(); } else if (checkCollision(refs.player, refs.stall, 50)) { gameState = 'PAUSED'; openShop(); }
        }
        requestAnimationFrame(sceneLoop);
    }

    // --- EXECU√á√ÉO PRINCIPAL E EVENTOS ---
    updateStatusBoard(); updateInventoryDisplay();
    playerState.x = 368; playerState.y = 500;
    refs.player.style.left = playerState.x + 'px'; refs.player.style.top = playerState.y + 'px';
    refs.shop.rerollButton.addEventListener('click', () => { if (playerState.shopRerolls > 0) { playerState.shopRerolls--; openShop(); } });
    refs.shop.proceedButton.addEventListener('click', () => { savePlayerState(playerState); window.location.href = 'jogosalas.html'; });
    refs.shop.closeButton.addEventListener('click', () => { refs.shop.overlay.classList.add('hidden'); gameState = 'PLAYING'; playerState.y += 20; });
    window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key)) keys[e.key] = true; });
    window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key)) keys[e.key] = false; });
    sceneLoop();
    </script>
</body>
</html>