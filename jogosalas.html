<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Lenda do Prato Equilibrado - Jogo Principal</title>
    <style>
        /* Seu CSS completo... */
        body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #222; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        .hidden { display: none !important; }
        #main-container { display: flex; gap: 20px; align-items: flex-start; }
        #game-container { position: relative; }
        #game-area { width: 800px; height: 600px; border: 2px solid #fff; background-image: url('imagens/fundo_floresta.png'); background-size: cover; position: relative; overflow: hidden; }
        .entity { position: absolute; background-size: contain; background-repeat: no-repeat; background-position: center; }
        #player { width: 64px; height: 64px; background-image: url('imagens/gatinho_pixel_32x32.png'); z-index: 10; }
        #ui-column { display: flex; flex-direction: column; align-items: center; }
        #status-board { font-size: 18px; margin-bottom: 10px; text-align: left; width: 250px; }
        #inventory-display { width: 250px; height: 550px; background-color: #1c2833; border: 2px solid #fff; padding: 10px; box-sizing: border-box; overflow-y: auto; }
        #inventory-title { margin: 0 0 10px 0; text-align: center; font-size: 20px; }
        .inventory-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(0, 0, 0, 0.95); }
        #main-menu { background-image: url('imagens/Mercado.png'); background-size: cover; background-position: center; }
        #main-menu .menu-button { font-size: 28px; padding: 18px 35px; margin: 12px; width: 350px; cursor: pointer; border: 2px solid #fff; background-color: #3498db; color: white; border-radius: 5px; transition: all 0.2s; }
        #main-menu .menu-button:hover { background-color: #4aa8e9; transform: scale(1.05); }
        /* NOVO: Estilo para o botão de reset, um pouco diferente para destaque */
        #reset-button { background-color: #c0392b; }
        #reset-button:hover { background-color: #e74c3c; }
        .enemy { width: 60px; height: 60px; background-image: url('imagens/inimigo_uva2.png'); }
        .projectile { width:15px; height:5px; background-color: #00aaff; box-shadow: 0 0 5px #00aaff; }
        .coin{width:15px;height:15px;background-color:#f1c40f;border-radius:50%}
        #room-message{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:48px;font-weight:700;color:#fff;text-shadow:2px 2px 4px #000;z-index:100}
        #choice-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; z-index: 150; }
        .choice-button { width: 80%; max-width: 600px; padding: 20px; font-size: 18px; cursor: pointer; background-color: #2c3e50; color: white; border: 2px solid #bda25a; border-radius: 10px; text-align: center; }
        .choice-button:hover { background-color: #34495e; }
        .item{width:32px;height:32px;} .banana{background-image:url(imagens/banana_32x32.png)} .leite{background-image:url(imagens/Leite_32x32.png)} .cenoura{background-image:url(imagens/cenoura_32x32.png)} .couve{background-image:url(imagens/couve_32x32.png)} .ovo{background-image:url(imagens/Ovo_32x32.png)}
    </style>
</head>
<body>
    <div id="main-container" class="hidden"> 
        <div id="game-container"> 
            <div id="game-area">
                <div id="player" class="entity"></div>
                <div id="choice-overlay" class="hidden"></div>
            </div> 
            <div id="room-message" class="hidden"></div> 
        </div> 
        <div id="ui-column"> 
            <div id="status-board"> 
                <div>Sala: <span id="current-room">0</span></div> 
                <div>Vida: <span id="player-health">10</span></div> 
                <div>Escudo: <span id="player-shield">0</span></div> 
                <div>Ataque: <span id="player-attack">1</span></div> 
                <div>Moedas: <span id="player-coins">30</span></div> 
            </div> 
            <div id="inventory-display"><h3 id="inventory-title">Itens</h3><div id="inventory-list"></div></div> 
        </div> 
    </div> 
    
    <div id="main-menu" class="screen"> 
        <h1>A Lenda do Prato Equilibrado</h1> 
        <button id="play-button" class="menu-button">Jogar</button> 
        <button id="reset-button" class="menu-button hidden">Encerrar Jornada</button>
    </div>

    <script>
    // --- LÓGICA DE DADOS ---
    function getNewPlayerState() { const state = { x: 385, y: 520, speed: 4, baseHealth: 10, bonusHealth: 0, baseAttack: 1, bonusAttack: 0, shield: 0, coins: 30, inventory: new Map(), currentRoom: 0, hasGrapesUpgrade: false, canSpawnEggs: false, milkUpgrade: false, bananaUpgrade: false, specialDishes: [] }; Object.defineProperty(state, 'health', { get() { return this.baseHealth + this.bonusHealth; }, configurable: true }); Object.defineProperty(state, 'attack', { get() { return this.baseAttack + this.bonusAttack; }, configurable: true }); return state; }
    function savePlayerState(state) { const savableState = { ...state, inventory: Array.from(state.inventory.entries()) }; localStorage.setItem('meuJoguinhoState_v27', JSON.stringify(savableState)); }
    function loadPlayerState() { const savedStateJSON = localStorage.getItem('meuJoguinhoState_v27'); if (!savedStateJSON) return null; const loadedObject = JSON.parse(savedStateJSON); const restoredState = { ...getNewPlayerState(), ...loadedObject, inventory: new Map(loadedObject.inventory) }; Object.defineProperty(restoredState, 'health', { get() { return this.baseHealth + this.bonusHealth; }, configurable: true }); Object.defineProperty(restoredState, 'attack', { get() { return this.baseAttack + this.bonusAttack; }, configurable: true }); return restoredState; }

    // --- SETUP DO JOGO ---
    const refs={ mainContainer:document.getElementById('main-container'), gameArea:document.getElementById('game-area'), player:document.getElementById('player'), roomMessage:document.getElementById('room-message'), choiceOverlay:document.getElementById('choice-overlay'), ui:{ room:document.getElementById('current-room'), health:document.getElementById('player-health'), shield:document.getElementById('player-shield'), attack:document.getElementById('player-attack'), coins:document.getElementById('player-coins'), inventory:document.getElementById('inventory-list') }, menu:{ main:document.getElementById('main-menu'), playBtn:document.getElementById('play-button'), resetBtn: document.getElementById('reset-button') } };
    let playerState;
    let gameState = 'MAIN_MENU';
    let currentRoom = 0;
    let lastTime = 0;
    let roomClearTimer = 0;
    const keys = {ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false};
    let activeEnemies = [], activeProjectiles = [], activeCoins = [], activeFood = [];
    const foodTypes=[{name:'banana',effect:()=>{playerState.health+=playerState.bananaUpgrade?3:1}},{name:'leite',effect:()=>{playerState.health+=playerState.milkUpgrade?2:1}},{name:'cenoura',effect:()=>{playerState.baseAttack+=1}},{name:'couve',effect:()=>{playerState.shield+=5}}];
    const specialFood=[{name:'ovo',effect:()=>{playerState.health+=1;playerState.baseAttack+=1}}];

    // --- FUNÇÕES DO JOGO ---
    function updateStatusBoard(){ refs.ui.room.textContent=currentRoom; refs.ui.health.textContent=playerState.health.toFixed(0); refs.ui.shield.textContent=playerState.shield.toFixed(0); refs.ui.attack.textContent=playerState.attack.toFixed(0); refs.ui.coins.textContent=playerState.coins; }
    function updateInventoryDisplay(){ refs.ui.inventory.innerHTML = ''; playerState.inventory.forEach((count, name) => { const itemEl = document.createElement('div'); itemEl.className = 'inventory-item'; itemEl.textContent = `${name} ${count > 1 ? `x${count}`:''}`; refs.ui.inventory.appendChild(itemEl); }); if (playerState.specialDishes) { playerState.specialDishes.forEach(dishName => { const itemEl = document.createElement('div'); itemEl.className = 'inventory-item'; itemEl.textContent = `Prato: ${dishName}`; refs.ui.inventory.appendChild(itemEl); }); } }
    function createEntity(className){ const div=document.createElement('div'); div.className=`entity ${className}`; refs.gameArea.appendChild(div); return div; }
    function createProjectile(){ const p={div:createEntity('projectile'), x: playerState.x + 24, y: playerState.y, speed: 8 }; p.div.style.left=p.x+'px'; p.div.style.top=p.y+'px'; activeProjectiles.push(p); }
    function createEnemy(x, y, health){ const e={div:createEntity('enemy'),x:x,y:y,health:health,speed:1+(currentRoom*0.1),dx:(Math.random()<0.5?1:-1),dy:(Math.random()<0.5?1:-1)}; e.div.style.left=e.x+'px'; e.div.style.top=e.y+'px'; activeEnemies.push(e); }
    function checkCollision(d1,d2){const r1=d1.getBoundingClientRect(),r2=d2.getBoundingClientRect();return !(r1.right<r2.left||r1.left>r2.right||r1.bottom<r2.top||r1.top>r2.bottom);}
    function showRoomMessage(text, duration) { refs.roomMessage.textContent = text; refs.roomMessage.classList.remove('hidden'); if (duration) { setTimeout(() => { refs.roomMessage.classList.add('hidden'); }, duration);} }
    function createCoin(x, y) { const coin = { div: createEntity('coin') }; coin.div.style.left = x + 'px'; coin.div.style.top = y + 'px'; activeCoins.push(coin); }
    function createFood(){ let possibleFoods = [...foodTypes]; if (playerState.canSpawnEggs) possibleFoods.push(...specialFood); if (possibleFoods.length === 0) return; const foodData = possibleFoods[Math.floor(Math.random() * possibleFoods.length)]; const food = { div: createEntity(`item ${foodData.name}`), effect: () => { foodData.effect(); updateStatusBoard(); } }; food.div.style.left = Math.random() * 770 + 'px'; food.div.style.top = Math.random() * 570 + 'px'; activeFood.push(food); }

    function startNewRoom() {
        currentRoom = playerState.currentRoom;
        updateStatusBoard();
        showRoomMessage(`Sala ${currentRoom}`, 1500);
        [...activeEnemies, ...activeProjectiles, ...activeCoins, ...activeFood].forEach(e => e.div.remove());
        activeEnemies = []; activeProjectiles = []; activeCoins = []; activeFood = [];
        const numEnemies = 1 + currentRoom;
        for (let i = 0; i < numEnemies; i++) { createEnemy(Math.random() * 700, Math.random() * 300, 3 + currentRoom); }
        const numFoods = 1 + Math.floor(Math.random() * 3);
        for (let i = 0; i < numFoods; i++) { createFood(); }
        playerState.x = 368; playerState.y = 520;
        gameState = 'PLAYING';
    }

    function presentPathChoice() {
        gameState = 'AWAITING_CHOICE';
        refs.choiceOverlay.classList.remove('hidden');
        refs.choiceOverlay.innerHTML = '';
        const allPaths = [ { text: "Floresta verdejante com cheiro de alimentos", page: 'loja_raposa.html' }, { text: "Bosque amarelo com um chamado misterioso", page: 'encontro_gato_sorte.html' }, { text: "Bosque azulado com um rosto conhecido", page: 'encontro_gato_mago.html' } ];
        const choices = allPaths.sort(() => 0.5 - Math.random()).slice(0, 2);
        choices.forEach(path => {
            const button = document.createElement('button');
            button.className = 'choice-button';
            button.textContent = path.text;
            button.onclick = () => { savePlayerState(playerState); window.location.href = path.page; };
            refs.choiceOverlay.appendChild(button);
        });
    }

    // --- LOOP PRINCIPAL ---
    function gameLoop() {
        // ... (todo o seu switch(gameState) permanece aqui)
        const now = performance.now();
        const deltaTime = (now - lastTime) / 1000 || 0;
        lastTime = now;

        switch (gameState) {
            case 'MAIN_MENU':
                // Mostra o botão de reset apenas se houver um jogo salvo
                if (localStorage.getItem('meuJoguinhoState_v27')) {
                    refs.menu.resetBtn.classList.remove('hidden');
                } else {
                    refs.menu.resetBtn.classList.add('hidden');
                }
                break;

            case 'STARTING_ROOM':
                refs.choiceOverlay.classList.add('hidden');
                startNewRoom();
                break;

            case 'PLAYING':
                // ... (toda a sua lógica de PLAYING, movimento, colisões, etc.)
                if(keys.ArrowUp) playerState.y -= playerState.speed; if(keys.ArrowDown) playerState.y += playerState.speed; if(keys.ArrowLeft) playerState.x -= playerState.speed; if(keys.ArrowRight) playerState.x += playerState.speed;
                playerState.y=Math.max(0,Math.min(playerState.y,536));
                playerState.x=Math.max(0,Math.min(playerState.x,736));
                refs.player.style.top = playerState.y + 'px'; refs.player.style.left = playerState.x + 'px';
                activeEnemies.forEach(e => { e.x += e.dx * e.speed; e.y += e.dy * e.speed; if (e.x <= 0 || e.x >= 740) e.dx *= -1; if (e.y <= 0 || e.y >= 540) e.dy *= -1; e.div.style.left = e.x + 'px'; e.div.style.top = e.y + 'px'; });
                for(let i=activeProjectiles.length-1; i>=0; i--){ let p = activeProjectiles[i]; p.y -= p.speed; if(p.y < -10){ p.div.remove(); activeProjectiles.splice(i,1); continue; } p.div.style.top = p.y + 'px'; for(let j=activeEnemies.length-1; j>=0; j--){ const e = activeEnemies[j]; if(checkCollision(p.div, e.div)){ p.div.remove(); activeProjectiles.splice(i,1); e.health -= playerState.attack; if(e.health <= 0){ createCoin(e.x, e.y); e.div.remove(); activeEnemies.splice(j,1); } break; } } }
                for (let i = activeCoins.length - 1; i >= 0; i--) { const coin = activeCoins[i]; if (checkCollision(refs.player, coin.div)) { playerState.coins += playerState.hasGrapesUpgrade ? 2 : 1; updateStatusBoard(); coin.div.remove(); activeCoins.splice(i, 1); } }
                for (let i = activeFood.length - 1; i >= 0; i--) { const food = activeFood[i]; if (checkCollision(refs.player, food.div)) { food.effect(); food.div.remove(); activeFood.splice(i, 1); } }
                if(activeEnemies.length === 0 && gameState === 'PLAYING'){ gameState = 'CLEARING_ROOM'; showRoomMessage('Sala Limpa!', 2000); roomClearTimer = 2.0; }
                break;
            
            case 'CLEARING_ROOM':
                roomClearTimer -= deltaTime;
                if (roomClearTimer <= 0) { playerState.currentRoom++; presentPathChoice(); }
                break;
        }
        
        requestAnimationFrame(gameLoop);
    }
    
    // --- INICIALIZAÇÃO E EVENTOS ---
    refs.menu.playBtn.addEventListener('click', () => {
        playerState = loadPlayerState() || getNewPlayerState();
        if(!localStorage.getItem('meuJoguinhoState_v27')) { savePlayerState(playerState); }
        refs.menu.main.classList.add('hidden'); refs.mainContainer.classList.remove('hidden');
        updateStatusBoard();
        updateInventoryDisplay();
        gameState = 'STARTING_ROOM';
    });
    
    // NOVO: Evento para o botão de encerrar jornada
    refs.menu.resetBtn.addEventListener('click', () => {
        if (confirm("Você tem certeza que deseja apagar todo o seu progresso? Esta ação não pode ser desfeita.")) {
            localStorage.removeItem('meuJoguinhoState_v27');
            alert("Seu progresso foi apagado! Uma nova jornada o aguarda.");
            refs.menu.resetBtn.classList.add('hidden'); // Esconde o botão após apagar
        }
    });

    window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key)) { e.preventDefault(); keys[e.key] = true; } if(e.key === ' ' && gameState === 'PLAYING') { e.preventDefault(); createProjectile(); } });
    window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key)) keys[e.key] = false; });
    
    gameLoop();
    </script>
</body>
</html>