<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Sala do Mercador</title>
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #222; font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; }
        .hidden { display: none !important; }
        #main-container { display: flex; gap: 20px; align-items: flex-start; }
        #game-container { position: relative; }
        #game-area { width: 800px; height: 600px; border: 2px solid #fff; background: url('imagens/florestamercador.png') center/cover no-repeat; position: relative; }
        .entity { position: absolute; background-size: contain; background-repeat: no-repeat; }
        #player { width: 64px; height: 64px; background-image: url('imagens/gatinho_pixel_32x32.png'); z-index: 10; }
        #npc-raposa { width: 128px; height: 128px; background-image: url('imagens/raposamercador.png'); top: 250px; left: 300px; cursor: pointer; }
        #mercado-stall { width: 230px; height: 230px; background-image: url('imagens/mercadoesquerdo.png'); top: 100px; left: 140px; cursor: pointer; }
        #ui-column { display: flex; flex-direction: column; align-items: center; }
        #status-board { font-size: 18px; margin-bottom: 10px; text-align: left; width: 250px; }
        #inventory-display { width: 250px; height: 550px; background-color: #1c2833; border: 2px solid #fff; padding: 10px; box-sizing: border-box; overflow-y: auto; }
        #inventory-title { margin: 0 0 10px 0; text-align: center; font-size: 20px; }
        #dialogue-box { display: flex; flex-direction: column; justify-content: center; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 750px; padding: 20px; background-color: rgba(10, 20, 40, 0.9); border: 3px solid #bda25a; border-radius: 10px; text-align: center; z-index: 200; }
        #dialogue-text { font-size: 22px; margin: 0 0 20px 0; min-height: 50px; }
        #dialogue-next-button { font-size: 18px; padding: 10px 20px; border: 2px solid #bda25a; background-color: #2c3e50; color: white; cursor: pointer; align-self: flex-end; }
        #shop-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(0, 0, 0, 0.85); }
        #shop-box { position: relative; padding: 20px; background-color: #1c2833; border: 2px solid #fff; border-radius: 10px; text-align: center; }
        #shop-close-button { position: absolute; top: 10px; right: 15px; font-size: 24px; color: white; background: none; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="game-container">
            <div id="game-area">
                <div id="player" class="entity"></div>
                <div id="npc-raposa" class="entity"></div>
                <div id="mercado-stall" class="entity"></div>
                <div id="dialogue-box" class="hidden">
                    <p id="dialogue-text"></p>
                    <button id="dialogue-next-button">Próximo ></button>
                </div>
            </div>
        </div>
        <div id="ui-column">
            <div id="status-board">
                <div>Sala: <span id="current-room">5</span></div> 
                <div>Vida: <span id="player-health">10</span></div> 
                <div>Escudo: <span id="player-shield">0</span></div> 
                <div>Ataque: <span id="player-attack">1</span></div> 
                <div>Moedas: <span id="player-coins">50</span></div> 
            </div> 
            <div id="inventory-display"><h3 id="inventory-title">Itens Comprados</h3></div> 
        </div>
    </div>
    
    <div id="shop-overlay" class="hidden">
        <div id="shop-box">
            <button id="shop-close-button">X</button>
            <h2>Loja do Mercador (Teste)</h2>
            <p>Aqui apareceriam os itens para comprar.</p>
            <p>Suas Moedas: <span id="player-coins-shop">50</span></p>
        </div>
    </div>

    <script>
        // --- REFERÊNCIAS ---
        const player = document.getElementById('player');
        const npc = document.getElementById('npc-raposa');
        const stall = document.getElementById('mercado-stall');
        const dialogueBox = document.getElementById('dialogue-box');
        const dialogueText = document.getElementById('dialogue-text');
        const nextButton = document.getElementById('dialogue-next-button');
        const shopOverlay = document.getElementById('shop-overlay');
        const shopCloseButton = document.getElementById('shop-close-button');
        const playerCoinsShopUI = document.getElementById('player-coins-shop');
        const playerCoinsStatusUI = document.getElementById('player-coins');

        // --- ESTADO DO JOGO ---
        let playerState = { x: 350, y: 400, speed: 4 }; 
        let sceneState = 'INTRO_DIALOGUE';
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };
        const introDialogues = ["Olá, jovem aventureiro! Que bom vê-lo por aqui.", "A floresta está perigosa com o exército da Rainha Uva...", "...mas não se preocupe, eu tenho os melhores produtos para te fortalecer!", "Fique à vontade para olhar minha barraca. Se precisar de algo, é só falar comigo!"];
        let dialogueIndex = 0;

        // --- SINCRONIZAÇÃO INICIAL ---
        player.style.left = playerState.x + 'px';
        player.style.top = playerState.y + 'px';

        // --- FUNÇÕES ---
        function advanceIntroDialogue() {
            if (dialogueIndex < introDialogues.length) {
                dialogueText.textContent = introDialogues[dialogueIndex];
                dialogueIndex++;
            } else {
                dialogueBox.classList.add('hidden');
                sceneState = 'PLAYING';
            }
        }
        
        function startIntroDialogue() {
            dialogueBox.classList.remove('hidden');
            nextButton.textContent = 'Próximo >';
            nextButton.onclick = advanceIntroDialogue;
            dialogueIndex = 0;
            advanceIntroDialogue();
        }
        
        function checkCollision(div1, div2, inset = 0) {
            const rect1 = div1.getBoundingClientRect();
            const rect2 = div2.getBoundingClientRect();
            const smallerRect2 = {
                left:   rect2.left + inset,
                right:  rect2.right - inset,
                top:    rect2.top + inset,
                bottom: rect2.bottom - inset
            };
            return !(rect1.right < smallerRect2.left || 
                     rect1.left > smallerRect2.right || 
                     rect1.bottom < smallerRect2.top || 
                     rect1.top > smallerRect2.bottom);
        }
        
        function sceneLoop() {
            if (sceneState === 'PLAYING') {
                // Movimentação
                if (keys.ArrowUp) playerState.y -= playerState.speed;
                if (keys.ArrowDown) playerState.y += playerState.speed;
                if (keys.ArrowLeft) playerState.x -= playerState.speed;
                if (keys.ArrowRight) playerState.x += playerState.speed;

                // --- CORREÇÃO ADICIONADA AQUI ---
                // Verifica e corrige a posição do jogador para mantê-lo dentro da área do jogo.
                const playerWidth = 64;
                const playerHeight = 64;
                const areaWidth = 800;
                const areaHeight = 600;

                // Checa a borda esquerda
                if (playerState.x < 0) {
                    playerState.x = 0;
                }
                // Checa a borda direita
                if (playerState.x > areaWidth - playerWidth) {
                    playerState.x = areaWidth - playerWidth;
                }
                // Checa a borda superior
                if (playerState.y < 0) {
                    playerState.y = 0;
                }
                // Checa a borda inferior
                if (playerState.y > areaHeight - playerHeight) {
                    playerState.y = areaHeight - playerHeight;
                }
                // --- FIM DA CORREÇÃO ---

                // Atualização visual
                player.style.top = playerState.y + 'px';
                player.style.left = playerState.x + 'px';

                // Checagem de colisão com interações
                if (checkCollision(player, stall, 75)) { // Usando valor ajustado para 64px
                    sceneState = 'PAUSED';
                    playerCoinsShopUI.textContent = playerCoinsStatusUI.textContent;
                    shopOverlay.classList.remove('hidden');
                } 
                else if (checkCollision(player, npc, 55)) { // Usando valor ajustado para 64px
                    sceneState = 'PAUSED';
                    dialogueText.textContent = "Compre, compre, compre! Tenho os melhores produtos!";
                    nextButton.textContent = "Fechar";
                    dialogueBox.classList.remove('hidden');
                    
                    nextButton.onclick = () => {
                        dialogueBox.classList.add('hidden');
                        sceneState = 'PLAYING';
                        playerState.y += 25; // Usando valor ajustado para 64px
                    };
                }
            }
            requestAnimationFrame(sceneLoop);
        }
        
        // --- EVENT LISTENERS ---
        window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key)) keys[e.key] = true; });
        window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key)) keys[e.key] = false; });
        
        shopCloseButton.addEventListener('click', () => {
            shopOverlay.classList.add('hidden');
            sceneState = 'PLAYING';
            playerState.y += 25; // Usando valor ajustado para 64px
        });

        // --- INÍCIO ---
        startIntroDialogue();
        sceneLoop();
    </script>
</body>
</html>