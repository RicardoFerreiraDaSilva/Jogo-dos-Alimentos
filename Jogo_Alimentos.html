<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prot√≥tipo V6 - Corre√ß√µes de Bugs</title>
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #222; color: white; font-family: sans-serif; }
        #main-container { display: flex; gap: 20px; align-items: flex-start; }
        #game-container { position: relative; }
        #game-area { width: 800px; height: 600px; border: 2px solid #fff; background-color: #2c3e50; position: relative; overflow: hidden; }
        .entity { position: absolute; }
        #player { width: 30px; height: 30px; background-color: #3498db; z-index: 10; }
        .item { width: 25px; height: 25px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 16px; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; }
        .enemy { width: 35px; height: 35px; background-color: #8e44ad; transition: all 0.1s; }
        .projectile, .pasta-projectile, .orange-projectile, .friend-projectile { width: 15px; height: 5px; background-color: #f1c40f; }
        .pasta-projectile { background-color: #e6e6e6; }
        .orange-projectile { background-color: #e67e22; border-radius: 5px;}
        .friend-projectile { background-color: #d35400; border-radius: 2px;}
        .coin { width: 15px; height: 15px; background-color: #f1c40f; border-radius: 50%; }
        .watermelon-orb { width: 40px; height: 40px; background-color: #27ae60; border: 2px solid #2ecc71; border-radius: 50%; opacity: 0.7; z-index: 9;}
        #chocolate-friend { width: 28px; height: 28px; background-color: #7b241c; border: 2px solid #d35400; }
        .banana { background-color: #ffda63; } .leite { background-color: #ffffff; color: black; } .cenoura { background-color: #e67e22; } .couve { background-color: #27ae60; } .ovo { background-color: #f7f1e3; border: 1px solid #aaa; color: #333; }
        #ui-column { display: flex; flex-direction: column; align-items: center; }
        #status-board { font-size: 18px; margin-bottom: 10px; text-align: left; width: 250px; }
        #inventory-display { width: 250px; height: 550px; background-color: #1c2833; border: 2px solid #fff; padding: 10px; box-sizing: border-box; overflow-y: auto; }
        #inventory-title { margin: 0 0 10px 0; text-align: center; font-size: 20px; }
        .inventory-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        #room-message { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 48px; font-weight: bold; color: white; text-shadow: 2px 2px 4px black; display: none; z-index: 100; }
        #shop-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #shop-title { font-size: 36px; margin-bottom: 20px; }
        #shop-items { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 650px; }
        .shop-item { width: 140px; height: 140px; padding: 5px; box-sizing: border-box; border: 2px solid #ddd; background-color: #444; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .shop-item.rare { border-color: #8e44ad; }
        .shop-item:hover { background-color: #555; transform: scale(1.05); }
        .shop-item.disabled { background-color: #222; color: #555; cursor: not-allowed; }
        .shop-item-symbol { font-size: 40px; }
        .shop-item-name { font-size: 16px; font-weight: bold; }
        #item-description { margin-top: 20px; height: 50px; font-size: 18px; text-align: center; }
        #proceed-button { margin-top: 20px; padding: 10px 20px; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="game-container">
            <div id="game-area">
                <div id="player" class="entity"></div>
            </div>
            <div id="room-message"></div>
            <div id="shop-overlay">
                <h2 id="shop-title">Mercado</h2>
                <div id="shop-items"></div>
                <p id="item-description">Passe o mouse sobre um item para ver a descri√ß√£o.</p>
                <button id="proceed-button">Ir para a pr√≥xima sala</button>
            </div>
        </div>
        <div id="ui-column">
            <div id="status-board">
                <div>Sala: <span id="current-room">0</span></div>
                <div>Vida: <span id="player-health">10</span></div>
                <div>Escudo: <span id="player-shield">0</span></div>
                <div>Ataque: <span id="player-attack">1</span></div>
                <div>Moedas: <span id="player-coins">30</span></div>
            </div>
            <div id="inventory-display">
                <h3 id="inventory-title">Itens Comprados</h3>
                <div id="inventory-list"></div>
            </div>
        </div>
    </div>

    <script>
        let gameState='SHOP', currentRoom=0;
        const refs={
            gameArea: document.getElementById('game-area'), player: document.getElementById('player'), roomMessage: document.getElementById('room-message'),
            shop: { overlay: document.getElementById('shop-overlay'), itemsContainer: document.getElementById('shop-items'), description: document.getElementById('item-description'), proceedButton: document.getElementById('proceed-button') },
            ui: { room: document.getElementById('current-room'), health: document.getElementById('player-health'), shield: document.getElementById('player-shield'), attack: document.getElementById('player-attack'), coins: document.getElementById('player-coins'), inventory: document.getElementById('inventory-list') }
        };

        let playerState = { 
            x: 385, y: 285, speed: 4, health: 10, shield: 0, attack: 1, coins: 30, isInvincible: false, invincibilityTimer: 0,
            lastMoveDirection: { x: 1, y: 0 }, inventory: new Map(),
            milkUpgrade: false, bananaUpgrade: false, hasPoisonUpgrade: false, poisonDPS: 1, hasGrapesUpgrade: false, canSpawnEggs: false, 
            aimInMoveDirection: false, hasDoubleShot: false, hasPastaShot: false, pastaFireRate: 1, pastaFireTimer: 1, pastaSlowFactor: 0,
            watermelonOrb: { damage: 0, angle: 0, radius: 60 }, extraShopSlots: 0, orangeUpgrade: 0, orangeFireTimer: 5, orangeJuiceUpgrade: false,
            hasHomingShots: false, chocolateFriend: { exists: false, x: 0, y: 0, health: 0, damage: 0, fireTimer: 2 }
        };
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };

        const foodTypes = [
            { name: 'banana', effect: () => { playerState.health += playerState.bananaUpgrade ? 3 : 1; } },
            { name: 'leite', effect: () => { playerState.health += playerState.milkUpgrade ? 2 : 1; } },
            { name: 'cenoura', effect: () => { playerState.attack += 1; } },
            { name: 'couve', effect: () => { playerState.shield += 5; } },
        ];
        const specialFood = [ { name: 'ovo', effect: () => { playerState.health += 1; playerState.attack += 1; } } ];

        let masterShopList = [
            { name:'Tomate',symbol:'üçÖ',desc:'Dobra seu ataque permanentemente.',cost:30,onPurchase:()=>{playerState.attack*=2;},stackable:false},
            { name:'Alface',symbol:'ü•¨',desc:'Concede 30 de escudo.',cost:30,onPurchase:()=>{playerState.shield+=30;},stackable:true},
            { name:'Caixa de Leite',symbol:'Lü•õ',desc:'Leite agora cura o dobro (passivo).',cost:30,onPurchase:()=>{playerState.milkUpgrade=true;},stackable:false},
            { name:'Laranja',symbol:'üçä',desc:'Dispara 5 proj√©teis a cada 5s (+2 de dano por compra).',cost:35,onPurchase:()=>{playerState.orangeUpgrade+=1;},stackable:true},
            { name:'Suco de Laranja',symbol:'üßÉ',desc:'(RARO) Dobra o dano dos proj√©teis do item Laranja.',cost:50,onPurchase:()=>{playerState.orangeJuiceUpgrade=true;},stackable:false,rarity:'rare'},
            { name:'Ma√ß√£',symbol:'üçé',desc:'Tiros t√™m 50% de chance de aplicar veneno.',cost:30,onPurchase:()=>{playerState.hasPoisonUpgrade=true;},stackable:false},
            { name:'Suco de Ma√ß√£',symbol:'ü•§',desc:'(RARO) Veneno da Ma√ß√£ causa +30 de dano por segundo.',cost:50,onPurchase:()=>{playerState.poisonDPS+=30;},stackable:false,rarity:'rare'},
            { name:'Uvas',symbol:'üçá',desc:'Moedas coletadas valem o dobro.',cost:30,onPurchase:()=>{playerState.hasGrapesUpgrade=true;},stackable:false},
            { name:'Melancia',symbol:'üçâ',desc:'Cria uma orbe de dano ao seu redor (+10 de dano por compra).',cost:40,onPurchase:()=>{playerState.watermelonOrb.damage+=10;if(!document.getElementById('watermelon-orb'))createEntity('watermelon-orb').id='watermelon-orb';},stackable:true},
            { name:'Frango',symbol:'üçó',desc:'Permite que Ovos apare√ßam nas fases (+1 Vida, +1 Dano).',cost:30,onPurchase:()=>{playerState.canSpawnEggs=true;},stackable:false},
            { name:'Bife',symbol:'ü•©',desc:'Seus tiros agora v√£o na dire√ß√£o em que voc√™ se move.',cost:30,onPurchase:()=>{playerState.aimInMoveDirection=true;},stackable:false},
            { name:'Coelho',symbol:'üêá',desc:'Atira um proj√©til adicional (tiro duplo).',cost:40,onPurchase:()=>{playerState.hasDoubleShot=true;},stackable:false},
            { name:'Ovelha',symbol:'üêë',desc:'Dobra o valor do seu escudo atual.',cost:25,onPurchase:()=>{if(playerState.shield>0)playerState.shield*=2;},stackable:true},
            { name:'Macarr√£o',symbol:'üçù',desc:'Ganha um tiro autom√°tico que causa lentid√£o (+10% por compra).',cost:35,onPurchase:()=>{playerState.hasPastaShot=true;playerState.pastaSlowFactor+=0.1;},stackable:true},
            { name:'Pepino',symbol:'ü•í',desc:'Adiciona +1 op√ß√£o de item no pr√≥ximo mercado (m√°x. 9).',cost:20,onPurchase:()=>{if(playerState.extraShopSlots<6)playerState.extraShopSlots++;},stackable:true},
            { name:'Batida de Banana',symbol:'üçå',desc:'Bananas agora curam 3 de vida.',cost:25,onPurchase:()=>{playerState.bananaUpgrade=true;},stackable:false},
            { name:'Bolo',symbol:'üéÇ',desc:'(RARO) Seu tiro principal se torna teleguiado.',cost:60,onPurchase:()=>{playerState.hasHomingShots=true;},stackable:false,rarity:'rare'},
            { name:'Chocolate',symbol:'üç´',desc:'(RARO) Conjura um amigo chocolate que luta ao seu lado.',cost:70,onPurchase:()=>{if(!playerState.chocolateFriend.exists){playerState.chocolateFriend.exists=true;playerState.chocolateFriend.health=Math.ceil(playerState.health/2);playerState.chocolateFriend.damage=Math.ceil(playerState.attack/2);playerState.chocolateFriend.x=playerState.x;playerState.chocolateFriend.y=playerState.y-40;const friendDiv=createEntity('chocolate-friend');friendDiv.id='chocolate-friend';}},stackable:false,rarity:'rare'},
            { name:'Chocolate Quente',symbol:'‚òï',desc:'+10 de Vida e Dano para seu amigo chocolate.',cost:30,onPurchase:()=>{if(playerState.chocolateFriend.exists){playerState.chocolateFriend.health+=10;playerState.chocolateFriend.damage+=10;}},stackable:true},
        ];
        masterShopList.forEach(item=>item.purchased=false);
        let currentShopItems=[]; let activeFood=[],activeProjectiles=[],activeEnemies=[],activeCoins=[],activePastaProjectiles=[],activeOrangeProjectiles=[],activeFriendProjectiles=[];
        
        function createEntity(className){const div=document.createElement('div');div.className=`entity ${className}`;refs.gameArea.appendChild(div);return div;}
        function createFood(){let f=[...foodTypes];if(playerState.canSpawnEggs)f.push(...specialFood);const d=f[Math.floor(Math.random()*f.length)];const e={div:createEntity(`item ${d.name}`),effect:d.effect};e.div.textContent=d.name.charAt(0).toUpperCase();e.div.style.left=Math.random()*775+'px';e.div.style.top=Math.random()*575+'px';activeFood.push(e);}
        function createEnemy(health){const e={div:createEntity('enemy'),x:Math.random()*765,y:Math.random()*565,speed:1+(currentRoom*0.1),health:health,dx:(Math.random()-0.5)*2,dy:(Math.random()-0.5)*2,slowFactor:1,isPoisoned:false,poisonTimer:0};activeEnemies.push(e);}
        function createProjectile(dir,offsetY=0){const p={div:createEntity('projectile'),x:playerState.x+15,y:playerState.y+12.5+offsetY,speed:8,dx:dir.x,dy:dir.y,homingTarget:null};p.div.style.left=p.x+'px';p.div.style.top=p.y+'px';activeProjectiles.push(p);}
        function createPastaProjectile(){if(activeEnemies.length===0)return;const t=findNearestEnemy(playerState);const d={x:t.x-playerState.x,y:t.y-playerState.y};const m=Math.sqrt(d.x**2+d.y**2)||1;const p={div:createEntity('pasta-projectile'),x:playerState.x+15,y:playerState.y+12.5,speed:5,dx:d.x/m,dy:d.y/m};p.div.style.left=p.x+'px';p.div.style.top=p.y+'px';activePastaProjectiles.push(p);}
        function createOrangeShot(){const dirs=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:0.7,y:0.7}];const dmg=(2+playerState.orangeUpgrade)*(playerState.orangeJuiceUpgrade?2:1);dirs.forEach(d=>{const p={div:createEntity('orange-projectile'),x:playerState.x+15,y:playerState.y+15,speed:4,dx:d.x,dy:d.y,damage:dmg};p.div.style.left=p.x+'px';p.div.style.top=p.y+'px';activeOrangeProjectiles.push(p);});}
        function createFriendProjectile(dir){const p={div:createEntity('friend-projectile'),x:playerState.chocolateFriend.x+14,y:playerState.chocolateFriend.y+14,speed:6,dx:dir.x,dy:dir.y,damage:playerState.chocolateFriend.damage};p.div.style.left=p.x+'px';p.div.style.top=p.y+'px';activeFriendProjectiles.push(p);}
        function createCoin(x,y){const c={div:createEntity('coin')};c.div.style.left=x+'px';c.div.style.top=y+'px';activeCoins.push(c);}
        
        function updateStatusBoard(){refs.ui.room.textContent=currentRoom;refs.ui.health.textContent=playerState.health;refs.ui.shield.textContent=playerState.shield;refs.ui.attack.textContent=playerState.attack;refs.ui.coins.textContent=playerState.coins;}
        function checkCollision(d1,d2){if(!d1||!d2)return false;const r1=d1.getBoundingClientRect(),r2=d2.getBoundingClientRect();return!(r1.right<r2.left||r1.left>r2.right||r1.bottom<r2.top||r1.top>r2.bottom);}
        function showRoomMessage(text,duration){refs.roomMessage.textContent=text;refs.roomMessage.style.display='block';if(duration)setTimeout(()=>{refs.roomMessage.style.display='none';},duration);}
        function updateInventoryDisplay(){refs.ui.inventory.innerHTML='';playerState.inventory.forEach((count,name)=>{const itemEl=document.createElement('div');itemEl.className='inventory-item';itemEl.textContent=`${name} ${count>1?`x${count}`:''}`;refs.ui.inventory.appendChild(itemEl);});}
        function findNearestEnemy(source){let nearest=null,minDist=Infinity;activeEnemies.forEach(e=>{const dist=Math.sqrt((e.x-source.x)**2+(e.y-source.y)**2);if(dist<minDist){minDist=dist;nearest=e;}});return nearest;}

        function openShop(){
            gameState='PAUSED'; refs.shop.overlay.style.display='flex'; refs.shop.itemsContainer.innerHTML='';
            const commonItems=masterShopList.filter(i=>i.rarity!=='rare' && (!i.purchased||i.stackable));
            const rareItems=masterShopList.filter(i=>i.rarity==='rare' && (!i.purchased||i.stackable));
            let itemsToShow=commonItems.sort(()=>0.5-Math.random()).slice(0,3+playerState.extraShopSlots);
            if(rareItems.length>0&&Math.random()<0.33)itemsToShow.push(rareItems.sort(()=>0.5-Math.random())[0]);
            
            itemsToShow.forEach(itemData=>{
                const itemDiv=document.createElement('div');itemDiv.className=`shop-item ${itemData.rarity||''}`;
                itemDiv.innerHTML=`<div class="shop-item-symbol">${itemData.symbol}</div><div class.shop-item-name">${itemData.name}</div>`;
                if(playerState.coins<itemData.cost)itemDiv.classList.add('disabled');
                itemDiv.addEventListener('mouseover',()=>{refs.shop.description.textContent=`${itemData.desc} (Custo: ${itemData.cost} moedas)`;}); // BUGFIX: Cost added to description
                itemDiv.addEventListener('click',()=>{if(playerState.coins>=itemData.cost&&(!itemData.purchased||itemData.stackable)){playerState.coins-=itemData.cost;itemData.onPurchase();const c=playerState.inventory.get(itemData.name)||0;playerState.inventory.set(itemData.name,c+1);if(!itemData.stackable)itemData.purchased=true;updateStatusBoard();updateInventoryDisplay();openShop();}});
                refs.shop.itemsContainer.appendChild(itemDiv);
            });
            refs.shop.description.textContent='Passe o mouse sobre um item para ver a descri√ß√£o.';
        }

        function closeShop(){refs.shop.overlay.style.display='none';currentRoom++;gameState='STARTING_ROOM';}
        refs.shop.proceedButton.addEventListener('click',closeShop);

        function handlePlayerDamage(amount){if(playerState.isInvincible)return;let d=Math.min(playerState.shield,amount);playerState.shield-=d;amount-=d;if(amount>0)playerState.health-=amount;playerState.isInvincible=true;playerState.invincibilityTimer=1.5;updateStatusBoard();}
        
        function startNewRoom(){
            showRoomMessage(`Sala ${currentRoom}`,1500);updateStatusBoard();
            [...activeFood,...activeCoins,...activeEnemies,...activePastaProjectiles,...activeOrangeProjectiles,...activeFriendProjectiles].forEach(i=>i.div.remove());
            activeFood=[];activeCoins=[];activeEnemies=[];activePastaProjectiles=[];activeOrangeProjectiles=[];activeFriendProjectiles=[];
            const nE=2+currentRoom;const eH=3+currentRoom;
            for(let i=0;i<nE;i++)createEnemy(eH);
            const nF=1+Math.floor(Math.random()*3);
            for(let i=0;i<nF;i++)createFood();
            gameState='PLAYING';
        }

        let lastTime=0;
        function gameLoop(){
            const now=performance.now();const deltaTime=(now-lastTime)/1000||0;lastTime=now;

            if(gameState==='SHOP'){openShop();gameState='PAUSED';} 
            else if(gameState==='PLAYING'){
                if(keys.ArrowUp){playerState.y-=playerState.speed;playerState.lastMoveDirection={x:0,y:-1};}
                if(keys.ArrowDown){playerState.y+=playerState.speed;playerState.lastMoveDirection={x:0,y:1};}
                if(keys.ArrowLeft){playerState.x-=playerState.speed;playerState.lastMoveDirection={x:-1,y:0};}
                if(keys.ArrowRight){playerState.x+=playerState.speed;playerState.lastMoveDirection={x:1,y:0};}
                playerState.y=Math.max(0,Math.min(playerState.y,570));playerState.x=Math.max(0,Math.min(playerState.x,770));
                refs.player.style.top=playerState.y+'px';refs.player.style.left=playerState.x+'px';
                if(playerState.isInvincible){playerState.invincibilityTimer-=deltaTime;refs.player.style.opacity=(refs.player.style.opacity=='0.5')?'1':'0.5';if(playerState.invincibilityTimer<=0){playerState.isInvincible=false;refs.player.style.opacity='1';}}
                
                if(playerState.orangeUpgrade>0){playerState.orangeFireTimer-=deltaTime;if(playerState.orangeFireTimer<=0){createOrangeShot();playerState.orangeFireTimer=5;}}
                if(playerState.watermelonOrb.damage>0){playerState.watermelonOrb.angle+=3*deltaTime;const oX=playerState.x-5+playerState.watermelonOrb.radius*Math.cos(playerState.watermelonOrb.angle);const oY=playerState.y-5+playerState.watermelonOrb.radius*Math.sin(playerState.watermelonOrb.angle);document.getElementById('watermelon-orb').style.left=oX+'px';document.getElementById('watermelon-orb').style.top=oY+'px';}
                if(playerState.hasPastaShot){playerState.pastaFireTimer-=deltaTime;if(playerState.pastaFireTimer<=0){createPastaProjectile();playerState.pastaFireTimer=playerState.pastaFireRate;}}
                
                // BUGFIX: Chocolate Friend logic corrected
                if(playerState.chocolateFriend.exists){
                    const friendDiv = document.getElementById('chocolate-friend');
                    playerState.chocolateFriend.x += (playerState.x - playerState.chocolateFriend.x) * 0.03;
                    playerState.chocolateFriend.y += ((playerState.y - 40) - playerState.chocolateFriend.y) * 0.03; // Corrected follow logic
                    friendDiv.style.left = playerState.chocolateFriend.x + 'px';
                    friendDiv.style.top = playerState.chocolateFriend.y + 'px';
                    playerState.chocolateFriend.fireTimer -= deltaTime;
                    if(playerState.chocolateFriend.fireTimer <= 0 && activeEnemies.length > 0){
                        const t = findNearestEnemy(playerState.chocolateFriend);
                        if(t){
                            const d={x:t.x-playerState.chocolateFriend.x,y:t.y-playerState.chocolateFriend.y};
                            const m=Math.sqrt(d.x**2+d.y**2)||1;
                            createFriendProjectile({x:d.x/m,y:d.y/m});
                            playerState.chocolateFriend.fireTimer=2;
                        }
                    }
                }

                for(let i=activeEnemies.length-1;i>=0;i--){const e=activeEnemies[i];const s=e.speed*e.slowFactor;e.x+=e.dx*s;e.y+=e.dy*s;if(e.x<=0||e.x>=765)e.dx*=-1;if(e.y<=0||e.y>=565)e.dy*=-1;e.div.style.left=e.x+'px';e.div.style.top=e.y+'px';const o=document.getElementById('watermelon-orb');if(playerState.watermelonOrb.damage>0&&o&&checkCollision(o,e.div))e.health-=playerState.watermelonOrb.damage*deltaTime;if(e.isPoisoned){e.health-=playerState.poisonDPS*deltaTime;e.poisonTimer-=deltaTime;if(e.poisonTimer<=0)e.isPoisoned=false;}if(checkCollision(refs.player,e.div))handlePlayerDamage(1);if(e.health<=0){createCoin(e.x,e.y);e.div.remove();activeEnemies.splice(i,1);}}
                
                function moveAndCheck(projArray, onHit){for(let i=projArray.length-1;i>=0;i--){let p=projArray[i];if(playerState.hasHomingShots&&projArray===activeProjectiles){const t=findNearestEnemy(p);if(t){const d={x:t.x-p.x,y:t.y-p.y};const m=Math.sqrt(d.x**2+d.y**2)||1;p.dx=d.x/m;p.dy=d.y/m;}}p.x+=p.dx*p.speed;p.y+=p.dy*p.speed;if(p.x>800||p.x<0||p.y>600||p.y<0){p.div.remove();projArray.splice(i,1);continue;}p.div.style.left=p.x+'px';p.div.style.top=p.y+'px';for(let j=activeEnemies.length-1;j>=0;j--){const e=activeEnemies[j];if(checkCollision(p.div,e.div)){p.div.remove();projArray.splice(i,1);onHit(e,p);if(e.health<=0){createCoin(e.x,e.y);e.div.remove();activeEnemies.splice(j,1);}break;}}}}
                
                moveAndCheck(activeProjectiles,(e,p)=>{e.health-=playerState.attack;if(playerState.hasPoisonUpgrade&&Math.random()<0.5){e.isPoisoned=true;e.poisonTimer=3;}});
                moveAndCheck(activePastaProjectiles,(e,p)=>{e.slowFactor=1-playerState.pastaSlowFactor;setTimeout(()=>e.slowFactor=1,2000);});
                moveAndCheck(activeOrangeProjectiles,(e,p)=>{e.health-=p.damage;});
                moveAndCheck(activeFriendProjectiles,(e,p)=>{e.health-=p.damage;});
                
                activeFood.forEach((f,i)=>{if(checkCollision(refs.player,f.div)){f.effect();f.div.remove();activeFood.splice(i,1);updateStatusBoard();}});
                activeCoins.forEach((c,i)=>{if(checkCollision(refs.player,c.div)){playerState.coins+=playerState.hasGrapesUpgrade?2:1;c.div.remove();activeCoins.splice(i,1);updateStatusBoard();}});

                if(activeEnemies.length===0&&gameState==='PLAYING'){gameState='CLEARING_ROOM';showRoomMessage('Sala Limpa!',null);setTimeout(()=>{if((currentRoom+1)%5===0){gameState='SHOP';}else{currentRoom++;gameState='STARTING_ROOM';}},2000);}
            }
            else if(gameState==='STARTING_ROOM'){startNewRoom();}
            
            requestAnimationFrame(gameLoop);
        }
        
        window.addEventListener('keydown',e=>{if(keys.hasOwnProperty(e.key))keys[e.key]=true;});
        window.addEventListener('keyup',e=>{if(keys.hasOwnProperty(e.key))keys[e.key]=false;});
        window.addEventListener('keydown',e=>{
            if (e.key===' '&&gameState==='PLAYING'){
                e.preventDefault();
                let dir = playerState.aimInMoveDirection ? playerState.lastMoveDirection : {x: 1, y: 0};
                // BUGFIX: Coelho (Tiro Duplo)
                if(playerState.hasDoubleShot) {
                    // Calcula a dire√ß√£o perpendicular para o offset
                    const perpDir = { x: -dir.y, y: dir.x };
                    createProjectile(dir, perpDir.y * 5); // Offset de 5 pixels para um lado
                    createProjectile(dir, perpDir.y * -5); // Offset de 5 pixels para o outro
                } else {
                    createProjectile(dir, 0); // Tiro √∫nico normal
                }
            }
        });

        updateStatusBoard();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>